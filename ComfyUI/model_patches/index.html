
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../data_types/">
      
      
        <link rel="next" href="../../Guidance/00_guidance/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Model Patches - 11yu on Tech For AI Image Generation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
      <link rel="stylesheet" href="../../style.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#model-patches" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="11yu on Tech For AI Image Generation" class="md-header__button md-logo" aria-label="11yu on Tech For AI Image Generation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            11yu on Tech For AI Image Generation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Model Patches
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="11yu on Tech For AI Image Generation" class="md-nav__button md-logo" aria-label="11yu on Tech For AI Image Generation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    11yu on Tech For AI Image Generation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ComfyUI
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    ComfyUI
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../00_comfyui_intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Exploring Internals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data_types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Model Patches
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Patches
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modelsamplingdiscrete" class="md-nav__link">
    <span class="md-ellipsis">
      
        ModelSamplingDiscrete
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelsamplingsd3" class="md-nav__link">
    <span class="md-ellipsis">
      
        ModelSamplingSD3
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelsamplingauraflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        ModelSamplingAuraFlow
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#differentialdiffusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        DifferentialDiffusion
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#freeu-freeu_v2" class="md-nav__link">
    <span class="md-ellipsis">
      
        FreeU / FreeU_V2
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fresca" class="md-nav__link">
    <span class="md-ellipsis">
      
        FreSca
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cfg-mods" class="md-nav__link">
    <span class="md-ellipsis">
      
        CFG Mods
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CFG Mods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rescalecfg" class="md-nav__link">
    <span class="md-ellipsis">
      
        RescaleCFG
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#renormcfg" class="md-nav__link">
    <span class="md-ellipsis">
      
        RenormCFG
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cfgnorm" class="md-nav__link">
    <span class="md-ellipsis">
      
        CFGNorm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adaptive-projected-guidance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adaptive Projected Guidance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tangential-damping-cfg" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tangential Damping CFG
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#self-attention-guidance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Self-Attention Guidance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perturbedattentionguidance" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerturbedAttentionGuidance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mahiro-is-so-cute-that-she-deserves-a-better-guidance-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mahiro is so cute that she deserves a better guidance function!! (。・ω・。)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" class="md-nav__link">
    <span class="md-ellipsis">
      
        Appendix
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clarifying-rescale-and-renorms" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clarifying Rescale and Renorms
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Guidance
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guidance
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Guidance/00_guidance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What is Guidance?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Guidance/01_cg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Classifier Guidance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    CFG
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    CFG
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Guidance/CFG/00_cfg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What is CFG?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Guidance/CFG/cfgpp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CFG++
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Models/00_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction To Generative Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Models/01_diffusion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Models/04_vae/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VAE (Variational AutoEncoder)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Models/12_training_objectives/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    [DD] Training Diffusion Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Models/99_notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Additional Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Sampling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Sampling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Sampling/00_sampling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What is Sampling?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Sampling/01_accuracy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    "Accuracy / Control"
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Sampling/03_sample_speed/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Generation Speed and How to Go Faster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Sampling/04_types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Types of Sampling Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Sampling/05_training_free_list/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    (Non-exhaustive) List of Training-Free Samplers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Sampling/06_training_based_list/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    (Non-exhaustive) List of Training-Based Sampling Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Sampling/07_tldr_usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Practical TL;DR of Samplers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Schedule
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Schedule
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/00_schedule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What is a Noise Schedule?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/01_schedule_list/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    (Non-exhaustive) List of Schedulers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Appendix
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Appendix
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Appendix/other_guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Other Guides
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Appendix/references/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    References
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Appendix/special_thanks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Special Thanks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modelsamplingdiscrete" class="md-nav__link">
    <span class="md-ellipsis">
      
        ModelSamplingDiscrete
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelsamplingsd3" class="md-nav__link">
    <span class="md-ellipsis">
      
        ModelSamplingSD3
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelsamplingauraflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        ModelSamplingAuraFlow
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#differentialdiffusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        DifferentialDiffusion
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#freeu-freeu_v2" class="md-nav__link">
    <span class="md-ellipsis">
      
        FreeU / FreeU_V2
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fresca" class="md-nav__link">
    <span class="md-ellipsis">
      
        FreSca
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cfg-mods" class="md-nav__link">
    <span class="md-ellipsis">
      
        CFG Mods
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CFG Mods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rescalecfg" class="md-nav__link">
    <span class="md-ellipsis">
      
        RescaleCFG
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#renormcfg" class="md-nav__link">
    <span class="md-ellipsis">
      
        RenormCFG
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cfgnorm" class="md-nav__link">
    <span class="md-ellipsis">
      
        CFGNorm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adaptive-projected-guidance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adaptive Projected Guidance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tangential-damping-cfg" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tangential Damping CFG
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#self-attention-guidance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Self-Attention Guidance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perturbedattentionguidance" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerturbedAttentionGuidance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mahiro-is-so-cute-that-she-deserves-a-better-guidance-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mahiro is so cute that she deserves a better guidance function!! (。・ω・。)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" class="md-nav__link">
    <span class="md-ellipsis">
      
        Appendix
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clarifying-rescale-and-renorms" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clarifying Rescale and Renorms
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="model-patches">Model Patches</h1>
<p>This page is roughly for nodes that input and output a <code>model</code>, modifying said model in some way (like adjusting the cfg function, noise schedule, etc.)</p>
<p>At the beginning of each section you can find a summary table, formatted like below:</p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>Which models work with the node in theory. In practice you can try whatever, though results will vary.</td>
</tr>
<tr>
<td>Purpose</td>
<td>Why / When to use this node, at least in theory.</td>
</tr>
<tr>
<td>Notes</td>
<td>Some things that I feel are important</td>
</tr>
</tbody>
</table>
<h3 id="modelsamplingdiscrete">ModelSamplingDiscrete</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>Diffusion</td>
</tr>
<tr>
<td>Purpose</td>
<td>Manually change prediction type.</td>
</tr>
<tr>
<td>Notes</td>
<td>You only need this node <strong>if the model file doesn't contain metadata</strong> about which type to use; If it does then comfy will detect it and this node serves no purpose.</td>
</tr>
</tbody>
</table>
<ul>
<li><strong><code>sampling</code>:</strong> Match this with what the model you're using was trained on.<ul>
<li><strong><code>eps</code>:</strong> Predict the noise to remove. Also called <span class="arithmatex">\(\epsilon\)</span> (<strong>eps</strong>ilon) prediction.</li>
<li><strong><code>v_prediction</code>:</strong> Predict the velocity (a mix between noise and data; not to be confused with flow matching's velocity).</li>
<li><strong><code>lcm</code>:</strong> <a href="https://arxiv.org/abs/2310.04378"><strong>L</strong>atent <strong>C</strong>onsistency <strong>M</strong>odels</a> mode. Intended for <a href="../../Sampling/06_training_based_list/">#distill models / loras</a> that use ideas from LCM, like SDXL Lightning, Hyper, DMD2, etc.<br />
Not required per se, but using this follows the theory and probably improves the quality.</li>
<li><strong><code>x_0</code>:</strong> Predict the data (clean image). Also called <span class="arithmatex">\(x_0\)</span> prediction.</li>
<li><strong><code>img_to_img</code>:</strong> I'd guess for <a href="https://arxiv.org/abs/2409.18124">Lotus</a> based on when this was added and the commit message adding it.</li>
</ul>
</li>
<li><strong><code>zsnr: true</code>:</strong> Force a <strong>Z</strong>ero-Terminal <strong>S</strong>ignal-to-<strong>N</strong>oise <strong>R</strong>atio schedule. See <a href="../Models/02_training_objectives.md#current-schedules-are-bad">#current schedules are bad</a> for why this is important. Intended for <code>v_prediction</code>.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Details</p>
<p><strong><code>sampling: eps, x0, v_prediction</code></strong> are mathematically connected through these formulae:</p>
<p><span class="arithmatex">\(x_\theta=\frac1{\alpha_t}(x_t-\sigma_t\epsilon_\theta)=\alpha_tx_t-\sigma_tv_\theta\)</span></p>
<p>Where <span class="arithmatex">\(\alpha, \sigma\)</span> are numbers relating to the noise schedule, <span class="arithmatex">\(x_\theta, \epsilon_\theta, v_\theta\)</span> are the various prediction types, and <span class="arithmatex">\(x_t\)</span> is the noise-image-mix currently being diffused.  </p>
<p>This means <em>in theory</em>, you can run an eps-pred model as a v-pred model. In practice, it's best that you use the type that the model was trained with.</p>
<ul>
<li>The model we train already isn't perfect, and it's best to stick to what it was trained with lest it performs worse (train-inference mismatch).</li>
<li>In certain situations, <span class="arithmatex">\(\alpha_t, \sigma_t\)</span> may become 0 / infinite, breaking down the mathematical connection.</li>
</ul>
</div>
<h3 id="modelsamplingsd3">ModelSamplingSD3</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>Flow Matching</td>
</tr>
<tr>
<td>Purpose</td>
<td>Quality enhancement (<strong>improve composition</strong>).</td>
</tr>
<tr>
<td>Notes</td>
<td>Sets <span class="arithmatex">\(\sigma_\text{max}\)</span> and <span class="arithmatex">\(\sigma_\text{min}\)</span> to 1 and 0, respectively, as is expected for flow matching. This unfortunately means you can't easily apply <code>shift</code> to diffusion models, even if in theory you can.</td>
</tr>
</tbody>
</table>
<ul>
<li><strong><code>shift</code>:</strong> Higher <code>shift</code> biases the model to spend more time on higher noise levels, theoretically improving composition while removing detail.<ul>
<li><code>1</code> disables shift.</li>
<li><code>3</code> is the default determined by the SD3 team through human preference testing on 1024x1024. <code>6</code> was a close second.</li>
</ul>
</li>
</ul>
<p><strong>Motivation:</strong> SD3 realized that using the same scheduler for different resolution images is a bad idea.</p>
<p><strong>Intuition:</strong> You start with random noise, the models pick up on its patterns to make stuff like shapes, details, etc. Higher resolution = more pixels = too many patterns = too many local details + bad composition.</p>
<div class="admonition note">
<p class="admonition-title">Details</p>
<p>To "bias models to certain noise levels," <code>shift</code> re-maps timesteps. Specifically:
$$
t_\text{new}=\frac{\text{shift}\times t_\text{old}}{1+(\text{shift}-1)\times t_\text{old}}
$$</p>
</div>
<h3 id="modelsamplingauraflow">ModelSamplingAuraFlow</h3>
<p>Same as <code>ModelSamplingSD3</code>.</p>
<div class="admonition note">
<p class="admonition-title">Details</p>
<p>The two only differ in how they make the model represent <code>timestep</code>s, however, I don't think comfy explicitly uses those anywhere, or if it does, it's always as a percentage anyway, so it doesn't matter.<br />
Specifically, due to how the theory evolved, there are 2 conventions: represent <code>timestep</code> from 0 to 1 or from 0 to 1000. <code>ModelSamplingAuraFlow</code> uses the former while <code>ModelSamplingSD3</code> uses the latter.</p>
</div>
<h3 id="differentialdiffusion"><a href="https://differential-diffusion.github.io/">DifferentialDiffusion</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>All models</td>
</tr>
<tr>
<td>Purpose</td>
<td>Improve inpainting (<strong>Improve blending at mask edges</strong>).</td>
</tr>
</tbody>
</table>
<p>An inpaint mask, which may contain values ranging from 0 to 1, by default results in a binary decision of "this pixel should(n't) be inpainted." </p>
<p><code>DifferentialDiffusion</code> enables models to utilize the full range of mask values, using them as "how much change should be applied to this pixel."</p>
<p>Theoretically improves blending at borders / reduces seams.</p>
<h3 id="freeu-freeu_v2"><a href="https://chenyangsi.top/FreeU/">FreeU / FreeU_V2</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>UNets (<code>sd1.5</code>, <code>sdxl</code>)</td>
</tr>
<tr>
<td>Purpose</td>
<td>Quality enhancement</td>
</tr>
</tbody>
</table>
<ul>
<li><strong><code>s1, s2</code>:</strong> Skip-connection attenuation scale. Higher = suppress skip-connection outputs. Supposedly decreases unnatural details.</li>
<li><strong><code>b1, b2</code>:</strong> Backbone strengthening scale. Higher = amplify backbone outputs. Supposedly improves denoising ability.</li>
</ul>
<p>YMMV. Probably have to do an exhaustive search to find the best parameters. </p>
<div class="admonition note">
<p class="admonition-title">Details</p>
<p>"Free lunch for diffusion UNets that improve quality with no cost." -authors</p>
<p>UNet outputs comprise two parts: backbone and skip-connections. Authors argue that the backbone is more important, and at the same time, skip-connections may introduce unnatural high-frequency features.</p>
</div>
<h3 id="fresca"><a href="https://wikichao.github.io/FreSca/">FreSca</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>All models</td>
</tr>
<tr>
<td>Purpose</td>
<td>Quality enhancement</td>
</tr>
</tbody>
</table>
<p>Apply independent scaling to high-frequency (details) and low-frequency (structure) features.</p>
<p>Paraphrasing:</p>
<ul>
<li><strong><code>scale_high: &gt;1, scale_low: 1</code>:</strong> "fine-detail enhancement"</li>
<li><strong><code>scale_high: &lt;1, scale_low: &gt;1</code>:</strong> "smoothing"</li>
<li><strong><code>scale_high, scale_low: 1</code>:</strong> disables functionality</li>
</ul>
<p><strong><code>freq_cutoff</code>:</strong> Higher = more stuff is considered low frequency.</p>
<h2 id="cfg-mods">CFG Mods</h2>
<p><strong>Overshooting</strong> - usually occuring due to a cfg guiding effect that is too strong - is when an image during sampling is guided outside of what the model has been trained on, so the model panics and starts making poor predictions.</p>
<p>Overshooting leads to low-quality images, with common issues including extreme saturation, color distortion, and a general lack of detail. I'll collective call these artifacts <strong>cfg burn.</strong></p>
<div class="admonition note">
<p class="admonition-title">Details</p>
<p>For this section, I'll be assuming that the normal cfg function looks like the following:
$$
x_\text{cfg}=x_n+w(x_p-x_n)
$$
Where <span class="arithmatex">\(x_\text{cfg}\)</span> is the normal cfg denoised result, <span class="arithmatex">\(w\)</span> is cfg, <span class="arithmatex">\(x_p\)</span> is positive prediction, and <span class="arithmatex">\(x_n\)</span> is negative prediction. When these symbols are used later that's what they mean.</p>
</div>
<h3 id="rescalecfg"><a href="https://arxiv.org/abs/2305.08891">RescaleCFG</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>All models (originally intended for v-pred)</td>
</tr>
<tr>
<td>Purpose</td>
<td>Mitigate overshooting.</td>
</tr>
<tr>
<td>Notes</td>
<td><strong>Does nothing if cfg is 1.</strong></td>
</tr>
</tbody>
</table>
<p>This takes the original cfg denoised result <span class="arithmatex">\(x_\text{cfg},\)</span> and scale it down into <span class="arithmatex">\(x_\text{scaled}\)</span> to prevent overshoot. The two are then averaged together and that becomes the final model output. </p>
<p>The authors chose to not directly use <span class="arithmatex">\(x_\text{scaled}\)</span> as the final model output, because "the generated images are overly plain." </p>
<ul>
<li><strong><code>multiplier</code>:</strong> cfg rescale multiplier <span class="arithmatex">\(\phi.\)</span> Higher = use more of the rescaled result to make the mix.<ul>
<li>For example, <code>0.7</code> means that the final output is 70% <span class="arithmatex">\(x_\text{scaled}\)</span> and 30% <span class="arithmatex">\(x_\text{cfg}.\)</span></li>
</ul>
</li>
</ul>
<p>Compared to simply lowering cfg, this ideally preserves the strong guiding effect of high cfg, but tones it down dynamically during sampling if it's about to overshoot.</p>
<div class="admonition note">
<p class="admonition-title">Deatils</p>
<p>Changes the cfg function to the following:
$$
x_\text{final}=\phi\times\frac{\text{std}(x_p)}{\text{std}(x_\text{cfg})}\times x_\text{cfg}+(1-\phi)\times x_\text{cfg}
$$
Where <span class="arithmatex">\(x_\text{final}\)</span> is the final output and <span class="arithmatex">\(\text{std}\)</span> is the standard deviation.</p>
<p><strong>Motivation:</strong> <span class="arithmatex">\(x_\text{cfg}\)</span> may become too big, especially with high cfg and/or opposite pointing <span class="arithmatex">\(x_p,x_n,\)</span> making the model overshoot. </p>
<p><strong>Fix:</strong> Match the size of <span class="arithmatex">\(x_\text{cfg}\)</span> to that of <span class="arithmatex">\(x_p.\)</span> </p>
</div>
<h3 id="renormcfg">RenormCFG</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>All models (originally from Lumina Image 2.0)</td>
</tr>
<tr>
<td>Purpose</td>
<td>Mitigate overshooting.</td>
</tr>
<tr>
<td>Notes</td>
<td><strong>Does nothing if cfg is 1.</strong></td>
</tr>
</tbody>
</table>
<ul>
<li><strong><code>cfg_trunc</code>:</strong> during sampling, set cfg to 1 at high noise levels (when <code>sigma &gt; cfg_trunc</code>), otherwise sample normally. <ul>
<li>This doesn't trigger comfy's fast sampling optimization (where if you set <code>cfg = 1</code>, comfy recognizes it can skip calculating the negative, resulting in 2x speed).</li>
<li><code>100</code>: Flow models' <span class="arithmatex">\(\sigma\)</span> range from 1 to 0, so this is intended as the "disable this function" big value. You can connect a <code>Float (utils &gt; primitive)</code> to it and set it bigger if you need it.</li>
</ul>
</li>
<li><strong><code>renorm_cfg</code>:</strong> cfg renorm multiplier <span class="arithmatex">\(\rho.\)</span> <ul>
<li><code>0</code>: Disable.</li>
<li><code>&lt;1</code>: Image becomes very washed very fast.</li>
<li><code>&gt;1</code>: Does renorm less aggressively. Higher = less effect = closer to no renorm.</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Deatils</p>
<p>Actually combines 2 techniques, <a href="https://arxiv.org/abs/2412.07730">CFG-Renormalization</a> and <a href="https://arxiv.org/abs/2503.21758">CFG-Truncation</a>.</p>
<p>CFG-Renorm, like CFG-Rescale, also seeks to mitigate overshoot, and also uses <span class="arithmatex">\(x_p\)</span> as a guide. CFG-Renorm just uses this formula instead:
$$
x_\text{final}=\rho\times\frac{||x_p||}{||x_\text{cfg}||}\times x_\text{cfg}
$$
Where <span class="arithmatex">\(||...||\)</span> is the L2 norm, in other words <span class="arithmatex">\(\sqrt{x_1^2+x_2^2+x_3^2+...}\)</span> where the <span class="arithmatex">\(x_1,x_2\)</span> etc are the elements of said tensor.</p>
<p>CFG-Trunc skips using cfg at later steps because some other research found it affects little.<br />
...which would mean that comfy's nodes and the research it's based on do opposite things (comfy skips at early steps)? Probably just me being dumb and overlooking something, but idk.</p>
</div>
<h3 id="cfgnorm">CFGNorm</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>All models (originally from Hidream E1)</td>
</tr>
<tr>
<td>Purpose</td>
<td>Mitigate overshooting.</td>
</tr>
<tr>
<td>Notes</td>
<td><strong>Does nothing if cfg is 1.</strong></td>
</tr>
</tbody>
</table>
<p>Similar to (but no the same as) CFG-Renormalization.</p>
<h3 id="adaptive-projected-guidance"><a href="https://arxiv.org/abs/2410.02416">Adaptive Projected Guidance</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>All models.</td>
</tr>
<tr>
<td>Purpose</td>
<td>Mitigate overshooting.</td>
</tr>
</tbody>
</table>
<ul>
<li><strong><code>eta</code>:</strong> Scaling of parallel component. <ul>
<li><code>&gt;1</code>: Higher saturation.</li>
<li><code>0~1</code>: Intended usage.</li>
<li><code>&lt;0</code>: Probably don't (moves away from positive).</li>
</ul>
</li>
<li><strong><code>renorm_threshold</code>:</strong> Higher = less aggresive renorming.</li>
<li><strong><code>momentum</code>:</strong> Influence of previous steps on current step<ul>
<li><code>&lt;0</code>: Intended usage. Push the model away from the prior prediction direction.</li>
</ul>
</li>
</ul>
<p>Some recommend <strong><code>eta: 1, norm_threshold: 20, momentum: 0</code></strong> to replace <code>RescaleCFG</code> for vpred.</p>
<div class="admonition note">
<p class="admonition-title">Details</p>
<p>APG incorporates 3 ideas:</p>
<ol>
<li>
<p><strong>Supress parallel component:</strong> Specifically, decompose <span class="arithmatex">\(D=w(x_p-x_n)\)</span> into two components, one parallel and one perpendicular to the positive prediction <span class="arithmatex">\(x_p:\)</span></p>
<ul>
<li>Parallel: Seems to be responsible for saturation.</li>
<li>Perpendicular: Seems to be responsible for image quality improvements.  </li>
</ul>
<p>Thus, it makes sense to scale the parallel component by some factor <span class="arithmatex">\(\eta &lt;1.\)</span></p>
</li>
<li>
<p><strong>Renormalize CFG:</strong> It's renorm again but different (tm). APG constrains <span class="arithmatex">\(D\)</span> to have a size of at most <code>renorm_threshold</code>.</p>
</li>
<li>
<p><strong>Reverse momentum:</strong> Add a negative momentum term that pushes the model away from previously taken directions and encourages the model to focus more on the current update direction.</p>
</li>
</ol>
</div>
<h3 id="tangential-damping-cfg"><a href="https://5410tiffany.github.io/tcfg.github.io/">Tangential Damping CFG</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>All models.</td>
</tr>
<tr>
<td>Purpose</td>
<td>Mitigate overshooting.</td>
</tr>
</tbody>
</table>
<p><strong>Intuition:</strong> During sampling, the negative prediction still points towards "natural images;" Trying to move away from it thus may have unintended consequences.</p>
<ul>
<li>Example: You negative <code>chibi</code>. However, <code>chibi</code> still lies in the overall space of anime images. So, besides removing <code>chibi</code>, you're actually also subtly telling the model to move away from anime images in general. Oops.</li>
</ul>
<p><strong>Fix:</strong> Remove the part of the negative prediction that points towards natural images, so when you move away from it, you don't move away from natural images. </p>
<div class="admonition note">
<p class="admonition-title">Details</p>
<p>Oversimplified, the idea is that a model, in learning how to transform noise to noise-image mixes to good images, also implicitly learns how to transform noise-image mixes to unnatural images that don't appear in training data. (proven through complex math).</p>
<p>The component to remove from <span class="arithmatex">\(x_n\)</span> is approximated using said information and the <a href="https://en.wikipedia.org/wiki/Singular_value_decomposition">SVD</a> algorithm.</p>
</div>
<h3 id="self-attention-guidance"><a href="https://cvlab-kaist.github.io/Self-Attention-Guidance/">Self-Attention Guidance</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>All models</td>
</tr>
<tr>
<td>Purpose</td>
<td>Quality enhancement (<strong>clarity / remove blur and melting color blobs</strong>)</td>
</tr>
<tr>
<td>Notes</td>
<td><strong>Reduce your cfg accordingly. Increases generation time.</strong></td>
</tr>
</tbody>
</table>
<ul>
<li><strong><code>scale</code>:</strong> how much the SAG results influence things. Higher = more effect.</li>
<li><strong><code>blur_sigma</code>:</strong> the std of the Gaussian it uses for blur guidance. Higher = more aggressive blurring.</li>
</ul>
<p>In essence, SAG does the following:</p>
<ul>
<li>Identify high information (thus, difficult to diffuse) regions through the model's self-attention map.</li>
<li>Blur this part with Gaussian noise, then predict with the model, resulting in a prediction based on blurry inputs.</li>
<li>Do the usual cfg sampling on the original unblurred image. Then, additionally, move away from the blurry input prediction by <code>scale</code>.</li>
</ul>
<p>This should <strong>help most in regions where the model is very unconfident</strong> about what to put there, e.g., melting backgrounds.<br />
It probably doesn't help in regions where the model is confident, whether confidently right or confidently wrong.</p>
<h3 id="perturbedattentionguidance"><a href="https://cvlab-kaist.github.io/Perturbed-Attention-Guidance/">PerturbedAttentionGuidance</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>All models</td>
</tr>
<tr>
<td>Purpose</td>
<td>Quality enhancement (<strong>remove degraded predictions</strong>)</td>
</tr>
<tr>
<td>Notes</td>
<td><strong>Reduce your cfg accordingly: <code>PAG_scale + new_cfg = original_cfg</code></strong> should be a good rule of thumb. <strong>Increases generation time.</strong></td>
</tr>
</tbody>
</table>
<p>Sequel to <code>Self-Attention Guidance</code>. They do different things, so you can use both at once.</p>
<p>In essence, PAG does the following:</p>
<ul>
<li>Make a <em>perturbed</em> model by removing its self-attention and replacing it with an identity matrix. Have it predict on the image.</li>
<li>Do the usual cfg sampling on the original image. Then, additionally, move away from the perturbed model prediction by <code>scale</code>.</li>
</ul>
<h3 id="mahiro-is-so-cute-that-she-deserves-a-better-guidance-function"><a href="https://huggingface.co/spaces/yoinked/blue-arxiv">Mahiro is so cute that she deserves a better guidance function!! (。・ω・。)</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>Applicable To</td>
<td>All models</td>
</tr>
<tr>
<td>Purpose</td>
<td>Quality enhancement (<strong>Better alignment to positive</strong>)</td>
</tr>
</tbody>
</table>
<p><strong>Motivation:</strong> normal cfg's negative prompt implicitly has the effect of making the model pay attention to the polar opposite of said negative.</p>
<p><strong>Fix:</strong> When applicable, pay more attention to the positive and less to the negative.</p>
<div class="admonition note">
<p class="admonition-title">Details</p>
<p>Specifically:</p>
<ol>
<li>Calculate "positive leap," which is <span class="arithmatex">\(\text{cfg}\times x_p.\)</span> In the same vein, calculate "negative leap."<ul>
<li>A "leap" semantically means "following positive/negative." cfg means "follow positive <em>as well as</em> move away from negative."</li>
</ul>
</li>
<li>Merge the positive leap and cfg, then calculate the similarity between that and the negative leap.<ul>
<li>High similarity: The leap was bad, trust cfg more.</li>
<li>Low similarity: The leap was good, trust the leap more.</li>
</ul>
</li>
</ol>
<p>(Find the quick read in the link, id <code>2024-1208.1</code>. Find a graph <a href="https://www.desmos.com/calculator/wcztf0ktiq">here</a> comparing normal cfg and mahiro.)</p>
</div>
<h2 id="appendix">Appendix</h2>
<h3 id="clarifying-rescale-and-renorms">Clarifying Rescale and Renorms</h3>
<p>Ultimately, all aforementioned rescale/renorm methods aim to prevent model overshooting by reducing the "size" of intermediate outputs during the sampling process.</p>
<p>The difference lies in how they measure the size, and which intermediate output they apply resizing to:</p>
<table>
<thead>
<tr>
<th></th>
<th><code>RescaleCFG</code></th>
<th><code>RenormCFG</code></th>
<th><code>CFGNorm</code></th>
<th><code>Adaptive Projected Guidance</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>Size measure</td>
<td>standard deviation</td>
<td>l2 norm</td>
<td>l2 norm</td>
<td>l2 norm</td>
</tr>
<tr>
<td>Resizing applied to</td>
<td>model cfg output</td>
<td>model cfg output</td>
<td>intermediate sample</td>
<td>specific component of model cfg output</td>
</tr>
<tr>
<td>Notes</td>
<td>Final output is a mix of the unscaled and scaled output</td>
<td></td>
<td>Only uses the channel dimension to calculate size</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>"model cfg output" is <span class="arithmatex">\(x_\text{cfg}=x_\text{negative}+\text{cfg}\times(x_\text{positive}-x_\text{negative}).\)</span> </li>
<li>"intermediate sample" is the noise-image-mix during sampling. <ul>
<li>For example, using a noise-prediction model, you'd repeatedly do <span class="arithmatex">\(x_\text{next}=x_\text{prev}-x_\text{cfg}\)</span> until <span class="arithmatex">\(x_\text{next}\)</span> becomes a clean image. <span class="arithmatex">\(x_\text{next}\)</span> is what <code>CFGNorm</code> resizes.</li>
</ul>
</li>
<li><code>Adaptive Projected Guidance</code> decomposes <span class="arithmatex">\(\text{cfg}\times(x_\text{positive}-x_\text{negative})\)</span> further and resizes a part of that.</li>
</ul>
<p>What implications does this have in practice? IDFK, experiment ig.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>